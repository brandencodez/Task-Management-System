<!-- admin-attendance.component.html -->
<app-navbar [role]="'admin'"></app-navbar>

<div class="admin-attendance-container">
  <!-- Enhanced Header -->
  <div class="admin-header">
    <div class="header-top">
      <div class="header-left">
        <div class="header-icon">üìä</div>
        <div class="header-text">
          <h1>Attendance Management </h1>
          <div class="header-subtitle">
            Real-time monitoring & analytics dashboard
          </div>
        </div>
      </div>
      
      <div class="header-actions">
        <button class="header-btn" (click)="sendReminder()">
          <span>üîî</span> Send Reminder
        </button>
        
        <!-- Download Button with Dropdown - View only -->
        <div class="download-dropdown">
          <button 
            class="header-btn download-btn" 
            title="Download Attendance in different formats"
            (click)="exportToPDF()"
          >
            <span>üì•</span> Download Report (PDF)
          </button>
        </div>
        
      <!-- Settings Dropdown -->
<div class="settings-dropdown">
  <button
    class="settings-btn"
    title="Settings"
    (click)="toggleSettings($event)"
  >
    ‚öôÔ∏è
  </button>

  <div class="settings-menu" *ngIf="showSettings">
    <div class="setting-item">
      <label class="switch">
        <input type="checkbox"
               [(ngModel)]="autoMarkEnabled"
               (change)="toggleAutoMark()">
        <span class="slider"></span>
      </label>
      <span>Auto-mark absent</span>
    </div>

    <div class="setting-item">
      <label class="switch">
        <input type="checkbox"
               [(ngModel)]="notificationsEnabled"
               (change)="toggleNotifications()">
        <span class="slider"></span>
      </label>
      <span>Notifications</span>
    </div>
  </div>
</div>

      </div>
    </div>
    
    <!-- Today's Overview -->
    <div class="today-overview">
      <div class="overview-item present" (click)="filterByStatus('present')">
        <span class="count">{{ todayOverview.present }}</span>
        <span class="label">Present</span>
      </div>
      <div class="overview-item absent" (click)="filterByStatus('absent')">
        <span class="count">{{ todayOverview.absent }}</span>
        <span class="label">Absent</span>
      </div>
      <div class="overview-item half-day" (click)="filterByStatus('half-day')">
        <span class="count">{{ todayOverview.halfDay }}</span>
        <span class="label">Half Day</span>
      </div>
      <div class="overview-item leave" (click)="filterByStatus('leave')">
        <span class="count">{{ todayOverview.leave }}</span>
        <span class="label">On Leave</span>
      </div>
      <div class="overview-item not-marked" (click)="filterByStatus('not-marked')" *ngIf="todayOverview.notMarked > 0">
        <span class="count">{{ todayOverview.notMarked }}</span>
        <span class="label">Pending</span>
      </div>
      <div class="overview-item total">
        <span class="count">{{ todayOverview.total }}</span>
        <span class="label">Total Employees</span>
      </div>
    </div>
  </div>

  <!-- View Toggle Container -->
  <div class="view-toggle-container">
    <div class="view-toggle-header">
      <h2>Dashboard Views</h2>
      <div class="view-actions">
        <span class="current-date">{{ selectedDate | date:'fullDate' }}</span>
      </div>
    </div>
    
    <div class="view-toggle">
      <button 
        class="toggle-btn" 
        [class.active]="selectedView === 'daily'"
        (click)="onViewChange('daily')"
      >
        <span class="btn-icon">üìÖ</span> Daily Attendance
      </button>
      <button 
        class="toggle-btn" 
        [class.active]="selectedView === 'monthly'"
        (click)="onViewChange('monthly')"
      >
        <span class="btn-icon">üìà</span> Monthly Analytics
      </button>
    </div>
  </div>

  <!-- DAILY VIEW -->
  @if (selectedView === 'daily') {
    <div class="daily-view">
      <!-- Date & Stats Section -->
      <div class="date-section">
        <div class="date-selector">
          <div class="date-input-group">
            <label for="attendanceDate">
              <span class="calendar-icon">üìÖ</span> Select Date:
            </label>
            <input 
              type="date" 
              id="attendanceDate" 
              [value]="selectedDate"
              (change)="onDateChange($event)"
              class="date-input"
            />
            <button class="today-btn" (click)="selectToday()">
              <span class="today-icon">‚ö°</span> Today
            </button>
          </div>
          
          <div class="office-time-info">
            <span class="time-icon">üïê</span>
            <span>Office Hours: 9:30 AM - {{ officeEndTime }}</span>
            <span class="auto-mark-info" *ngIf="autoMarkEnabled">
              ‚Ä¢ Auto-mark enabled ({{ officeEndTime }})
            </span>
          </div>
        </div>

        <!-- Quick Stats -->
      <div class="quick-stats">

  <div class="quick-stat">
    <div class="stat-icon">‚è∞</div>
    <div class="stat-content">
      <h3>{{ quickStats.onTime }}</h3>
      <p>On Time Arrivals</p>
    </div>
  </div>

  <div class="quick-stat">
    <div class="stat-icon">üö®</div>
    <div class="stat-content">
      <h3>{{ quickStats.lateComers }}</h3>
      <p>Late Arrivals</p>
    </div>
  </div>

  <div class="quick-stat">
    <div class="stat-icon">üö™</div>
    <div class="stat-content">
      <h3>{{ quickStats.earlyLeavers }}</h3>
      <p>Early Departures</p>
    </div>
  </div>

</div>


      </div>

      <!-- Search & Filter Section -->
      <div class="search-filter-section">
        <div class="search-container">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input 
              type="text" 
              placeholder="Search employees by name, department" 
              [(ngModel)]="searchQuery"
              (input)="onSearch()"
              class="search-input"
            />
          </div>
          
          <div class="filter-buttons">
            <button 
              class="filter-btn" 
              [class.active]="statusFilter === 'all'"
              (click)="filterByStatus('all')"
            >
              <span class="filter-icon">üìã</span> All
            </button>
            <button 
              class="filter-btn" 
              [class.active]="statusFilter === 'present'"
              (click)="filterByStatus('present')"
            >
              <span class="filter-icon">‚úÖ</span> Present
            </button>
            <button 
              class="filter-btn" 
              [class.active]="statusFilter === 'absent'"
              (click)="filterByStatus('absent')"
            >
              <span class="filter-icon">‚ùå</span> Absent
            </button>
            <button 
              class="filter-btn" 
              [class.active]="statusFilter === 'not-marked'"
              (click)="filterByStatus('not-marked')"
            >
              <span class="filter-icon">‚è≥</span> Pending
            </button>
          </div>
        </div>
      </div>

      <!-- Enhanced Employee Grid -->
      <div class="employee-grid-section">
        <div class="grid-header">
          <h3>Employee Attendance Details</h3>
          <div class="grid-actions">
            <select class="sort-select" [(ngModel)]="sortBy" (change)="onSortChange()">
              <option value="name">Sort by Name</option>
              <option value="status">Sort by Status</option>
              <option value="department">Sort by Department</option>
              <option value="checkIn">Sort by Check-in Time</option>
            </select>
          </div>
        </div>

        <div class="enhanced-employee-grid">
          @for (record of filteredRecords; track record.employeeId) {
            <div class="enhanced-employee-card-compact" [ngClass]="getStatusClass(record.status)">
              <div class="card-header-compact">
                <div class="employee-avatar-compact" [style.background]="getEmployeeColor(record.employeeId)">
                  {{ record.employeeName.charAt(0) }}
                </div>
                <div class="employee-info-compact">
                  <div class="employee-name">{{ record.employeeName }}</div>
                  <div class="employee-dept">{{ record.employeeDepartment }}</div>
                </div>
                <div class="status-badge-compact">
                  {{ getStatusIcon(record.status) }}
                </div>
              </div>
              
              <div class="card-body-compact">
                <div class="time-row"> 
                  <span class="time-label">In:</span>
                  <span class="time-value">
                    @if (record.checkInTime) {
                      {{ formatTime(record.checkInTime) | date:'shortTime' }}
                    } @else {
                      --
                    }
                  </span>
                </div>
                <div class="time-row">
                  <span class="time-label">Out:</span>
                  <span class="time-value">
                    @if (record.checkOutTime) {
                      {{ formatTime(record.checkOutTime) | date:'shortTime' }}
                    } @else {
                      --
                    }
                  </span>
                </div>
                <div class="time-row">
                  <span class="time-label">Work:</span>
                  <span class="time-value">{{ record.workHours || 0 }}h</span>
                </div>
                @if (record.project && record.project !== 'General') {
                  <div class="time-row">
                    <span class="time-label">Project:</span>
                    <span class="time-value project-name">{{ record.project }}</span>
                  </div>
                }
                @if (record.workDetails) {
                  <div class="work-details">
                    <span class="details-label">üìù Details:</span>
                    <p class="details-text">{{ record.workDetails }}</p>
                  </div>
                }
              </div>
              
              <div class="card-footer-compact">
                <button class="card-action-btn-sm" title="View Details">üëÅÔ∏è</button>
              </div>
            </div>
          } @empty {
            <div class="no-records">
              <div class="no-records-icon">üì≠</div>
              <h3>No employees found</h3>
              <p>Try changing your search or filter criteria</p>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- MONTHLY VIEW -->
  @if (selectedView === 'monthly') {
    <div class="monthly-view">
      <!-- Month Selector -->
      <div class="month-selector">
        <div class="selector-left">
          <label for="attendanceMonth">
            <span class="month-icon">üìÜ</span> Select Month:
          </label>
          <select 
            id="attendanceMonth" 
            [(ngModel)]="selectedMonth"
            (change)="onMonthChange()"
            class="month-select"
          >
            @for (month of months; track month) {
              <option [value]="formatMonth(month)">
                {{ month | date:'MMMM yyyy' }}
              </option>
            }
          </select>
        </div>
      </div>

      <!-- Employee List with Analytics -->
      <div class="employee-list-container">
        @for (summary of attendanceSummary; track summary.employeeId) {
          <div class="employee-summary-card" 
               [class.expanded]="expandedEmployeeId === summary.employeeId"
               (click)="toggleEmployeeDetails(summary.employeeId)">
            
            <!-- Summary Row -->
            <div class="summary-row">
              <div class="employee-col">
                <div class="employee-avatar-sm" [style.background]="getEmployeeColor(summary.employeeId)">
                  {{ summary.employeeName.charAt(0) }}
                </div>
                <div class="employee-info-sm">
                  <div class="name">{{ summary.employeeName }}</div>
                  <div class="dept">{{ summary.employeeDepartment }}</div>
                  <div class="trend" [ngClass]="getTrendClass(summary.trend)">
                    Trend: {{ summary.trend }}%
                  </div>
                </div>
              </div>
              
              <div class="stats-col">
                <div class="stat-cell" title="Present Days">
                  <div class="stat-value present">{{ summary.totalPresent }}</div>
                  <div class="stat-label">Present</div>
                </div>
                <div class="stat-cell" title="Absent Days">
                  <div class="stat-value absent">{{ summary.totalAbsent }}</div>
                  <div class="stat-label">Absent</div>
                </div>
                <div class="stat-cell" title="Half Days">
                  <div class="stat-value half-day">{{ summary.totalHalfDays }}</div>
                  <div class="stat-label">Half Day</div>
                </div>
                <div class="stat-cell" title="Leave Days">
                  <div class="stat-value leave">{{ summary.totalLeaves }}</div>
                  <div class="stat-label">Leave</div>
                </div>
              </div>
              
              <div class="percentage-col">
                <div class="percentage-container">
                  <div class="percentage-bar">
                    <div 
                      class="percentage-fill" 
                      [style.width.%]="summary.attendancePercentage"
                      [ngClass]="getPercentageClass(summary.attendancePercentage)"
                    ></div>
                  </div>
                  <div class="percentage-value">{{ summary.attendancePercentage }}%</div>
                </div>
                <div class="overall-status" [ngClass]="getOverallStatusClass(summary.attendancePercentage)">
                  {{ getOverallStatusText(summary.attendancePercentage) }}
                </div>
              </div>
              
              <div class="toggle-col">
                <span class="toggle-icon">
                  {{ expandedEmployeeId === summary.employeeId ? '‚ñº' : '‚ñ∂' }}
                </span>
              </div>
            </div>
            
            <!-- Expanded Analytics View -->
            @if (expandedEmployeeId === summary.employeeId) {
              <div class="graph-container">
                <h4>{{ summary.employeeName }} - {{ selectedMonth | date:'MMMM yyyy' }} Analytics</h4>
                
                <div class="side-by-side-container">
                  <!-- Left Panel: Bar Graph -->
                  <div class="left-panel">
                    <div class="attendance-bar-graph">
                      <h3>Attendance Distribution</h3>
                      <div class="graph-bars">
                        <!-- Present Bar -->
                        <div class="graph-bar-group">
                          <div class="bar-label">Present</div>
                          <div class="bar-container">
                            <div class="bar present-bar" [style.width.%]="summary.workingDays > 0 ? (summary.totalPresent / summary.workingDays) * 100 : 0">
                              <span class="bar-value">{{ summary.totalPresent }}</span>
                              <span class="bar-percentage">
                                {{ summary.workingDays > 0 ? ((summary.totalPresent / summary.workingDays) * 100).toFixed(1) + '%' : '0%' }}
                              </span>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Absent Bar -->
                        <div class="graph-bar-group">
                          <div class="bar-label">Absent</div>
                          <div class="bar-container">
                            <div class="bar absent-bar" [style.width.%]="summary.workingDays > 0 ? (summary.totalAbsent / summary.workingDays) * 100 : 0">
                              <span class="bar-value">{{ summary.totalAbsent }}</span>
                              <span class="bar-percentage">
                                {{ summary.workingDays > 0 ? ((summary.totalAbsent / summary.workingDays) * 100).toFixed(1) + '%' : '0%' }}
                              </span>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Half Day Bar -->
                        <div class="graph-bar-group">
                          <div class="bar-label">Half Day</div>
                          <div class="bar-container">
                            <div class="bar halfday-bar" [style.width.%]="summary.workingDays > 0 ? (summary.totalHalfDays / summary.workingDays) * 100 : 0">
                              <span class="bar-value">{{ summary.totalHalfDays }}</span>
                              <span class="bar-percentage">
                                {{ summary.workingDays > 0 ? ((summary.totalHalfDays / summary.workingDays) * 100).toFixed(1) + '%' : '0%' }}
                              </span>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Leave Bar -->
                        <div class="graph-bar-group">
                          <div class="bar-label">Leave</div>
                          <div class="bar-container">
                            <div class="bar leave-bar" [style.width.%]="summary.workingDays > 0 ? (summary.totalLeaves / summary.workingDays) * 100 : 0">
                              <span class="bar-value">{{ summary.totalLeaves }}</span>
                              <span class="bar-percentage">
                                {{ summary.workingDays > 0 ? ((summary.totalLeaves / summary.workingDays) * 100).toFixed(1) + '%' : '0%' }}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="graph-total">
                        <span class="total-label">Total Working Days:</span>
                        <span class="total-value">{{ summary.workingDays }}</span>
                      </div>
                      
                      <!-- Additional Metrics -->
                      <div class="additional-metrics">
                        <div class="metric">
                          <span class="metric-label">Avg. Work Hours:</span>
                          <span class="metric-value">{{ summary.averageWorkHours }}h</span>
                        </div>
                        <div class="metric">
                          <span class="metric-label">Total Overtime:</span>
                          <span class="metric-value">{{ summary.totalOvertime }}h</span>
                        </div>
                        <div class="metric">
                          <span class="metric-label">Late Arrivals:</span>
                          <span class="metric-value">{{ summary.lateArrivals || 0 }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Right Panel: Calendar Grid -->
                  <div class="right-panel">
                    <div class="calendar-grid-container">
                      <h5>Daily Attendance Calendar</h5>
                      <div class="calendar-grid">
                        @if (summary.monthlyData && summary.monthlyData.length > 0) {
                          @for (day of summary.monthlyData; track day.date) {
                            <div class="calendar-day" [ngClass]="'day-' + day.status" 
                                 [title]="(day.date | date:'dd MMM') + ': ' + 
                                          (day.status === 'not-marked' ? 'Not Marked' : 
                                           day.status === 'half-day' ? 'Half Day' : 
                                           day.status) + 
                                          (day.workHours ? ' (' + day.workHours + 'h)' : '')">
                              <div class="day-number">{{ day.date | date:'d' }}</div>
                              <div class="day-status">
                                @switch (day.status) {
                                  @case ('present') { ‚úÖ }
                                  @case ('absent') { ‚ùå }
                                  @case ('half-day') { ‚è∞ }
                                  @case ('leave') { üèñÔ∏è }
                                  @case ('not-marked') { ‚è≥ }
                                  @case ('future') { üìÖ }
                                }
                              </div>
                              @if (day.overtime > 0) {
                                <div class="overtime-badge">+{{ day.overtime }}h</div>
                              }
                            </div>
                          }
                        } @else {
                          <div class="no-data-message">
                            No attendance data available for this month
                          </div>
                        }
                      </div>
                      
                      <div class="calendar-legend">
                        <div class="legend-item">
                          <span class="legend-color present"></span> Present
                        </div>
                        <div class="legend-item">
                          <span class="legend-color absent"></span> Absent
                        </div>
                        <div class="legend-item">
                          <span class="legend-color half-day"></span> Half Day
                        </div>
                        <div class="legend-item">
                          <span class="legend-color leave"></span> Leave
                        </div>
                        <div class="legend-item">
                          <span class="legend-color not-marked"></span> Pending
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        } @empty {
          <div class="no-summary-records">
            <div class="no-records-icon">üìä</div>
            <h3>No attendance data for selected month</h3>
            <p>Attendance records will appear here once employees start marking attendance</p>
          </div>
        }
      </div>
    </div>
  }

</div>