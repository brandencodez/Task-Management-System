<div class="container">

  <div class="page-header">
    <h2>Project Management</h2>
    <button class="btn btn-primary" (click)="openAddForm()">Add Project</button>
  </div>

  <!-- ================= ADD / EDIT FORM ================= -->
  @if (showForm) {
    <div class="card form-card">
      <h3>{{ isEditing ? 'Edit Project' : 'Add Project' }}</h3>

      <form (ngSubmit)="saveProject()" class="form-grid">

        <!-- Project Name -->
        <div class="form-group">
          <label class="form-label">Project Name *</label>
          <input
            [(ngModel)]="currentProject.name"
            name="name"
            required
            class="form-control"
          />
        </div>

        <!-- Project Type -->
        <div class="form-group">
          <label class="form-label">Project Type</label>
          <input
            [(ngModel)]="currentProject.projectType"
            name="projectType"
            class="form-control"
          />
        </div>

        <!-- Department -->
        <div class="form-group">
          <label class="form-label">Department *</label>
          <select
            [(ngModel)]="currentProject.department_id"
            name="department_id"
            required
            class="form-control"
          >
            <option value="0">Select Department</option>
            @for (dept of departments; track dept.id) {
              <option [value]="dept.id">{{ dept.name }}</option>
            }
          </select>
        </div>

        <!-- ================= CLIENT DETAILS ================= -->

        <div class="form-group client-section">
          <label class="form-label">Company Details *</label>

          <!-- Company -->
          <input
            [(ngModel)]="currentProject.clientDetails.companyName"
            name="companyName"
            required
            class="form-control"
            placeholder="Company Name *"
          />

          <!-- Address -->
          <input
            [(ngModel)]="currentProject.clientDetails.address"
            name="address"
            class="form-control"
            placeholder="Address"
          />

          <!-- Contacts -->
          <div class="contacts-container">
            @for (contact of currentProject.clientDetails.contacts; track $index) {

              <div class="contact-row">

                <input
                  [(ngModel)]="currentProject.clientDetails.contacts[$index].name"
                  [name]="'contactName' + $index"
                  class="form-control"
                  placeholder="Contact Name *"
                  required
                />

                <select
                  [(ngModel)]="currentProject.clientDetails.contacts[$index].designation"
                  [name]="'contactDesignation' + $index"
                  class="form-control"
                >
                  <option value="">Designation</option>
                  <option value="Owner">Owner</option>
                  <option value="Founder">Founder</option>
                  <option value="CEO">CEO</option>
                  <option value="Director">Director</option>
                  <option value="Manager">Manager</option>
                  <option value="Project Manager">Project Manager</option>
                  <option value="Team Lead">Team Lead</option>
                </select>

                <input
                  [(ngModel)]="currentProject.clientDetails.contacts[$index]['contact for']"
                  [name]="'contactFor' + $index"
                  class="form-control"
                  placeholder="Contact For"
                />

                <input
                  type="email"
                  [(ngModel)]="currentProject.clientDetails.contacts[$index].email"
                  [name]="'contactEmail' + $index"
                  class="form-control"
                  placeholder="Email"
                />

                <input
                  [(ngModel)]="currentProject.clientDetails.contacts[$index].phone"
                  [name]="'contactPhone' + $index"
                  class="form-control"
                  placeholder="Phone *"
                  maxlength="10"
                  required
                />

                @if (currentProject.clientDetails.contacts.length > 1) {
                  <button
                    type="button"
                    class="btn-remove-contact"
                    (click)="removeClientContact($index)"
                  >
                    Ã—
                  </button>
                }

              </div>
            }

            <button
              type="button"
              class="btn-add-contact"
              (click)="addClientContact()"
            >
              + Add Contact
            </button>
          </div>
        </div>

        <!-- Project Brief -->
        <div class="form-group">
          <label class="form-label">Project Brief</label>
          <textarea
            [(ngModel)]="currentProject.projectBrief"
            name="projectBrief"
            class="form-control"
            rows="3"
          ></textarea>
        </div>

        <!-- Dates -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Start Date *</label>
            <input
              type="date"
              [(ngModel)]="currentProject.startDate"
              name="startDate"
              required
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Finish Date *</label>
            <input
              type="date"
              [(ngModel)]="currentProject.finishDate"
              name="finishDate"
              required
              class="form-control"
            />
          </div>
        </div>

        <!-- Status -->
        <div class="form-group">
          <label class="form-label">Status</label>
          <select [(ngModel)]="currentProject.status" name="status" class="form-control">
            @for (status of statuses; track status) {
              <option [value]="status">{{ status }}</option>
            }
          </select>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-success">
            {{ isEditing ? 'Update Project' : 'Save Project' }}
          </button>

          <button type="button" class="btn btn-outline" (click)="cancelForm()">
            Cancel
          </button>
        </div>

      </form>
    </div>
  }

  <!-- ================= PROJECTS LIST ================= -->

  @for (status of statuses; track status) {
    @if (getProjectsByStatus(status).length > 0) {

      <div class="status-section">

        <!-- Gradient Capsule (UNCHANGED) -->
        <h3 
          class="section-title"
          [ngClass]="{
            'upcoming-title': status === 'UPCOMING',
            'ongoing-title': status === 'ONGOING',
            'completed-title': status === 'COMPLETED'
          }"
        >
          {{ status }} Projects
        </h3>

        <div class="projects-grid">

          @for (project of getProjectsByStatus(status); track project.id) {

            <div class="project-card">

              <div class="project-header">
                <h4>{{ project.name }}</h4>
                <span class="badge badge-{{ status.toLowerCase() }}">
                  {{ status }}
                </span>
              </div>

              <div class="project-details">
                <p><strong>Type:</strong> {{ project.projectType || 'Not specified' }}</p>
                <p><strong>Company:</strong> {{ project.clientDetails.companyName }}</p>
                <p><strong>Department:</strong> {{ project.department_name }}</p>
                <p>
                  <strong>Duration:</strong>
                  {{ formatDateForDisplay(project.startDate) }}
                  to
                  {{ formatDateForDisplay(project.finishDate) }}
                </p>
                <p><strong>Brief:</strong> {{ project.projectBrief || 'No brief provided' }}</p>
              </div>

              <div class="project-actions">
                <button class="btn btn-outline" (click)="openEditForm(project)">Edit</button>
                <button class="btn btn-danger" (click)="deleteProject(project.id)">Delete</button>
              </div>

            </div>

          }

        </div>
      </div>
    }
  }

</div>